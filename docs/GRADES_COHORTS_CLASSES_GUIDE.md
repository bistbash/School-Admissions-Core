# מדריך: שכבות, מחזורים, כיתות ותאריכים

מדריך מקיף על איך המערכת עובדת עם שכבות גיל, מחזורים, כיתות ותאריכים.

---

## תוכן עניינים

1. [סקירה כללית](#סקירה-כללית)
2. [שכבות גיל (Grades)](#שכבות-גיל-grades)
3. [מחזורים (Cohorts)](#מחזורים-cohorts)
4. [כיתות (Classes)](#כיתות-classes)
5. [תאריכים ושנות לימודים](#תאריכים-ושנות-לימודים)
6. [איך הכל מתחבר יחד](#איך-הכל-מתחבר-יחד)
7. [דוגמאות מעשיות](#דוגמאות-מעשיות)
8. [חישובים אוטומטיים](#חישובים-אוטומטיים)

---

## סקירה כללית

המערכת מנהלת תלמידים באמצעות שלושה מושגים מרכזיים:

### 1. מחזור (Cohort)
- קבוצת תלמידים שהתחילו ללמוד באותה שנה
- מתחיל ב-1 בספטמבר של שנת ההתחלה
- מתקדם בכיתות: ט' → י' → י"א → י"ב
- מזוהה לפי **שנת התחלה** (startYear)

### 2. כיתה (Class)
- כיתה ספציפית בשנה ספציפית
- מזוהה לפי: **כיתה** (grade), **מקביל** (parallel), **מגמה** (track), **שנת לימודים** (academicYear)
- כל שנה יש כיתות חדשות (כי academicYear משתנה)

### 3. תלמיד (Student)
- שייך למחזור אחד (cohort)
- יכול להיות רשום לכיתות שונות בשנים שונות (enrollments)
- יש לו תאריך התחלת לימודים (studyStartDate)

---

## שכבות גיל (Grades)

### השכבות במערכת

המערכת תומכת ב-4 שכבות גיל:

| שכבה | שם בעברית | שנים בלימודים |
|------|-----------|----------------|
| ט' | ט' | שנה ראשונה |
| י' | י' | שנה שנייה |
| י"א | י"א | שנה שלישית |
| י"ב | י"ב | שנה רביעית (סיום) |

### התקדמות אוטומטית

תלמידים מתקדמים אוטומטית בשכבות:
- **ט'** → **י'** → **י"א** → **י"ב** → **סיום**

ההתקדמות מתרחשת ב-**1 בספטמבר** של כל שנה.

---

## מחזורים (Cohorts)

### מה זה מחזור?

**מחזור** הוא קבוצת תלמידים שהתחילו ללמוד באותה שנה.

### דוגמה:
- **מחזור 2024** = כל התלמידים שהתחילו ללמוד ב-2024
- ב-2024 הם בכיתה **ט'**
- ב-2025 הם בכיתה **י'**
- ב-2026 הם בכיתה **י"א**
- ב-2027 הם בכיתה **י"ב**
- ב-2028 הם מסיימים

### מבנה מחזור

```typescript
Cohort {
  id: 1,
  name: "מחזור נ"ב",        // שם בגימטריה
  startYear: 2024,          // שנת התחלה
  currentGrade: "ט'",       // כיתה נוכחית
  isActive: true            // האם פעיל
}
```

### חישוב כיתה נוכחית

המערכת מחשבת אוטומטית את הכיתה הנוכחית של מחזור לפי:

1. **שנת התחלה** (startYear)
2. **תאריך נוכחי**
3. **1 בספטמבר** = תחילת שנת לימודים

#### לוגיקה:

```typescript
// אם התאריך >= 1 בספטמבר
// שנת לימודים = שנה נוכחית
// אחרת
// שנת לימודים = שנה נוכחית - 1

const academicYear = isAfterSeptember1st ? currentYear : currentYear - 1;
const yearsDiff = academicYear - startYear;

// yearsDiff = 0 → ט'
// yearsDiff = 1 → י'
// yearsDiff = 2 → י"א
// yearsDiff = 3 → י"ב
// yearsDiff >= 4 → י"ב (סיים)
```

### דוגמאות חישוב

#### דוגמה 1: מחזור 2024 (1 בספטמבר 2024)
- **2024** (ט'): `2024 - 2024 = 0` → **ט'**
- **2025** (י'): `2025 - 2024 = 1` → **י'**
- **2026** (י"א): `2026 - 2024 = 2` → **י"א**
- **2027** (י"ב): `2027 - 2024 = 3` → **י"ב**
- **2028** (סיום): `2028 - 2024 = 4` → **י"ב** (לא פעיל)

#### דוגמה 2: מחזור 2023 (1 בספטמבר 2023)
- **2023** (ט'): `2023 - 2023 = 0` → **ט'**
- **2024** (י'): `2024 - 2023 = 1` → **י'**
- **2025** (י"א): `2025 - 2023 = 2` → **י"א**
- **2026** (י"ב): `2026 - 2023 = 3` → **י"ב**
- **2027** (סיום): `2027 - 2023 = 4` → **י"ב** (לא פעיל)

### מחזורים פעילים

מחזור נחשב **פעיל** אם הוא באחת מ-4 השכבות האחרונות:
- **ט'** (שנה נוכחית)
- **י'** (שנה נוכחית - 1)
- **י"א** (שנה נוכחית - 2)
- **י"ב** (שנה נוכחית - 3)

מחזורים ישנים יותר נחשבים **לא פעילים** (סיימו).

### גימטריה (Gematria)

המערכת משתמשת בגימטריה עברית לשמות מחזורים:

- **מחזור א'** = 1973 (שנה ראשונה)
- **מחזור ב'** = 1974
- **מחזור י'** = 1982
- **מחזור י"א** = 1983
- **מחזור י"ב** = 1984
- **מחזור כ'** = 1992
- **מחזור נ"ב** = 2024

---

## כיתות (Classes)

### מה זה כיתה?

**כיתה** היא קבוצת תלמידים ספציפית בשנה ספציפית.

### מבנה כיתה

```typescript
Class {
  id: 1,
  grade: "י'",              // שכבה
  parallel: "1",            // מקביל (1, 2, 3, או A, B, C)
  track: "מדעים",           // מגמה
  academicYear: 2025,       // שנת לימודים
  name: "י' 1 - מדעים",     // שם תצוגה
  isActive: true
}
```

### ייחודיות כיתה

כיתה מזוהה באופן ייחודי לפי:
- **grade** (כיתה)
- **parallel** (מקביל)
- **track** (מגמה)
- **academicYear** (שנת לימודים)

**דוגמה:**
- `י' 1 מדעים 2025` ≠ `י' 1 מדעים 2026` (שנים שונות)
- `י' 1 מדעים 2025` ≠ `י' 2 מדעים 2025` (מקבילים שונים)

### שנת לימודים (Academic Year)

**שנת לימודים** מתחילה ב-**1 בספטמבר** ומסתיימת ב-**31 באוגוסט**.

#### חישוב שנת לימודים:

```typescript
const now = new Date();
const currentYear = now.getFullYear();
const currentMonth = now.getMonth() + 1; // 1-12
const currentDay = now.getDate();

// אם התאריך >= 1 בספטמבר
const isAfterSeptember1st = currentMonth > 9 || (currentMonth === 9 && currentDay >= 1);

// שנת לימודים נוכחית
const academicYear = isAfterSeptember1st ? currentYear : currentYear - 1;
```

#### דוגמאות:

- **15 באוגוסט 2024** → שנת לימודים = **2023** (עדיין בשנה הקודמת)
- **1 בספטמבר 2024** → שנת לימודים = **2024** (שנה חדשה התחילה)
- **15 בדצמבר 2024** → שנת לימודים = **2024**

---

## תאריכים ושנות לימודים

### תאריכים חשובים

#### 1. תאריך התחלת לימודים (studyStartDate)
- תאריך שבו תלמיד התחיל ללמוד
- **חובה** לכל תלמיד
- משמש לחישוב מחזור וכיתה

#### 2. תאריך רישום לכיתה (enrollmentDate)
- תאריך שבו תלמיד נרשם לכיתה ספציפית
- כל enrollment יש תאריך רישום משלו

#### 3. 1 בספטמבר
- **תחילת שנת לימודים**
- כל החישובים מבוססים על תאריך זה
- מחזורים מתקדמים בכיתה ב-1 בספטמבר

### חישוב מחזור מתאריך

```typescript
// אם תלמיד התחיל ב-15 באוגוסט 2024
// → מחזור 2024 (כי 1 בספטמבר 2024 = תחילת שנת לימודים)

// אם תלמיד התחיל ב-1 בספטמבר 2024
// → מחזור 2024

// אם תלמיד התחיל ב-15 בספטמבר 2024
// → מחזור 2024
```

### חישוב כיתה מתאריך

```typescript
// תלמיד במחזור 2024, תאריך נוכחי: 15 בדצמבר 2024
// שנת לימודים = 2024 (כי >= 1 בספטמבר)
// yearsDiff = 2024 - 2024 = 0
// → כיתה: ט'

// תלמיד במחזור 2024, תאריך נוכחי: 15 בדצמבר 2025
// שנת לימודים = 2025
// yearsDiff = 2025 - 2024 = 1
// → כיתה: י'
```

---

## איך הכל מתחבר יחד

### זרימת נתונים

```
┌─────────────┐
│   Student   │
│             │
│ cohortId    │───┐
│ studyStart  │   │
│ Date        │   │
└─────────────┘   │
                  │
                  ▼
         ┌──────────────┐
         │   Cohort     │
         │              │
         │ startYear    │───► חישוב כיתה נוכחית
         │ currentGrade │     (ט', י', י"א, י"ב)
         │ isActive     │
         └──────────────┘
                  │
                  │
                  ▼
         ┌──────────────┐
         │  Enrollment  │───► קשר בין תלמיד לכיתה
         │              │
         │ studentId    │
         │ classId      │───┐
         │ enrollment   │   │
         │ Date         │   │
         └──────────────┘   │
                            │
                            ▼
                  ┌──────────────┐
                  │    Class     │
                  │              │
                  │ grade        │───► שכבה (ט', י', י"א, י"ב)
                  │ parallel     │───► מקביל (1, 2, 3)
                  │ track        │───► מגמה (מדעים, הנדסה)
                  │ academicYear │───► שנת לימודים (2024, 2025)
                  └──────────────┘
```

### דוגמה מלאה

#### תלמיד חדש: יוסי כהן

```typescript
// 1. יצירת תלמיד
Student {
  idNumber: "123456789",
  firstName: "יוסי",
  lastName: "כהן",
  cohortId: 1,                    // מחזור 2024
  studyStartDate: "2024-09-01",  // התחיל ב-1 בספטמבר 2024
}

// 2. המחזור שלו
Cohort {
  id: 1,
  name: "מחזור נ"ב",
  startYear: 2024,
  currentGrade: "ט'",            // חושב אוטומטית
  isActive: true
}

// 3. הכיתה שלו (2024-2025)
Class {
  id: 1,
  grade: "ט'",
  parallel: "1",
  track: "מדעים",
  academicYear: 2024,            // שנת לימודים 2024-2025
}

// 4. הרישום שלו
Enrollment {
  studentId: 1,
  classId: 1,
  enrollmentDate: "2024-09-01"
}
```

#### שנה הבאה (2025-2026)

```typescript
// המחזור מתקדם אוטומטית
Cohort {
  id: 1,
  currentGrade: "י'",            // התקדם מ-ט' ל-י'
}

// כיתה חדשה (כי academicYear השתנה)
Class {
  id: 2,
  grade: "י'",
  parallel: "1",
  track: "מדעים",
  academicYear: 2025,            // שנת לימודים 2025-2026
}

// enrollment חדש
Enrollment {
  studentId: 1,
  classId: 2,
  enrollmentDate: "2025-09-01"
}
```

---

## דוגמאות מעשיות

### דוגמה 1: יצירת תלמיד חדש

```typescript
// אפשרות 1: עם מחזור
await studentsService.create({
  idNumber: "123456789",
  firstName: "יוסי",
  lastName: "כהן",
  gender: "MALE",
  cohort: 2024,                  // מחזור 2024
  studyStartDate: "2024-09-01",
  grade: "ט'",                   // אופציונלי - יחושב אוטומטית
  parallel: "1",
  track: "מדעים",
});

// המערכת:
// 1. מוצאת/יוצרת מחזור 2024
// 2. מחשבת כיתה (ט' ב-2024)
// 3. מוצאת/יוצרת כיתה: ט' 1 מדעים 2024
// 4. יוצרת enrollment
```

### דוגמה 2: יצירת תלמיד עם כיתה בלבד

```typescript
// אפשרות 2: עם כיתה בלבד
await studentsService.create({
  idNumber: "123456789",
  firstName: "יוסי",
  lastName: "כהן",
  gender: "MALE",
  grade: "י'",                   // כיתה
  studyStartDate: "2023-09-01",  // תאריך התחלה
  parallel: "1",
  track: "מדעים",
});

// המערכת:
// 1. מחשבת מחזור מכיתה (י' → מחזור 2023)
// 2. מוצאת/יוצרת מחזור 2023
// 3. מוצאת/יוצרת כיתה: י' 1 מדעים 2024
// 4. יוצרת enrollment
```

### דוגמה 3: העברת תלמיד לכיתה אחרת

```typescript
// העברת תלמיד מכיתה ט' 1 מדעים לכיתה ט' 2 מדעים
await studentsService.update(studentId, {
  parallel: "2",                 // שינוי מקביל
  academicYear: 2024,            // אותה שנת לימודים
});

// המערכת:
// 1. מוצאת/יוצרת כיתה חדשה: ט' 2 מדעים 2024
// 2. יוצרת enrollment חדש
// 3. ה-enrollment הישן נשאר (היסטוריה)
```

### דוגמה 4: קידום מחזור שלם

```typescript
// קידום כל התלמידים במחזור 2024 לכיתה הבאה
await studentsService.promoteCohort(cohortId, 2025);

// המערכת:
// 1. מוצאת את כל התלמידים במחזור
// 2. מחשבת את הכיתה החדשה (י' במקום ט')
// 3. יוצרת כיתות חדשות לשנת לימודים 2025
// 4. יוצרת enrollments חדשים
```

---

## חישובים אוטומטיים

### 1. חישוב כיתה ממחזור

```typescript
// API: POST /api/cohorts/calculate-grade
{
  "cohortYear": 2024,
  "academicYear": 2025
}

// תשובה:
{
  "grade": "י'"
}
```

### 2. חישוב מחזור מכיתה

```typescript
// API: POST /api/cohorts/calculate-cohort
{
  "grade": "י'"
}

// תשובה:
{
  "startYear": 2023
}
```

### 3. חישוב תאריך התחלה

```typescript
// API: POST /api/cohorts/calculate-start-date
{
  "cohortYear": 2024,
  "grade": "ט'"
}

// תשובה:
{
  "startDate": "2024-09-01"
}
```

### 4. חישוב כיתה בתאריך ספציפי

```typescript
// מה הייתה הכיתה של מחזור 2024 ב-15 בדצמבר 2023?
const grade = cohortsService.calculateGradeAtDate(2024, new Date('2023-12-15'));
// תשובה: null (המחזור עוד לא התחיל)

// מה הייתה הכיתה של מחזור 2024 ב-15 בדצמבר 2024?
const grade = cohortsService.calculateGradeAtDate(2024, new Date('2024-12-15'));
// תשובה: "ט'"
```

---

## Best Practices

### 1. תמיד השתמש ב-studyStartDate

```typescript
// ✅ Good
studyStartDate: "2024-09-01"

// ❌ Bad
studyStartDate: null  // חובה!
```

### 2. השתמש ב-cohort במקום cohortId

```typescript
// ✅ Good - גמיש יותר
cohort: 2024
// או
cohort: "מחזור נ"ב"

// ❌ Bad - צריך לדעת את ה-ID
cohortId: 1
```

### 3. השתמש ב-academicYear לכיתות

```typescript
// ✅ Good - מפורש
academicYear: 2024

// ❌ Bad - משתמש בשנה נוכחית (עלול להיות שגוי)
// academicYear לא מוגדר
```

### 4. תמיד צור enrollments דרך המערכת

```typescript
// ✅ Good - דרך StudentsService
await studentsService.create({ ... });

// ❌ Bad - יצירה ישירה
await prisma.enrollment.create({ ... });
```

---

## Troubleshooting

### בעיה: כיתה לא נכונה לתלמיד

**פתרונות:**
1. בדוק את `studyStartDate` - האם נכון?
2. בדוק את `cohortId` - האם תואם ל-`studyStartDate`?
3. בדוק את `academicYear` - האם נכון?
4. הרץ `calculateGradeFromCohort` לבדיקה

### בעיה: מחזור לא מתקדם אוטומטית

**פתרונות:**
1. בדוק את `startYear` - האם נכון?
2. הרץ `ensureAllCohortsExist()` לעדכון אוטומטי
3. בדוק את התאריך הנוכחי - האם >= 1 בספטמבר?

### בעיה: כיתה לא נמצאת

**פתרונות:**
1. בדוק את `academicYear` - האם נכון?
2. בדוק את `grade`, `parallel`, `track` - האם תואמים?
3. צור כיתה חדשה אם לא קיימת

---

## סיכום

המערכת מנהלת תלמידים באמצעות:

1. **מחזורים** - קבוצות תלמידים לפי שנת התחלה
2. **כיתות** - כיתות ספציפיות בשנים ספציפיות
3. **Enrollments** - קשר בין תלמידים לכיתות

**חישובים אוטומטיים:**
- כיתה נוכחית של מחזור
- מחזור מכיתה
- תאריך התחלה
- שנת לימודים

**תאריכים חשובים:**
- **1 בספטמבר** = תחילת שנת לימודים
- **studyStartDate** = תאריך התחלת לימודים של תלמיד
- **enrollmentDate** = תאריך רישום לכיתה

למידע נוסף:
- [Backend Development Guide](./BACKEND_DEVELOPMENT.md)
- [Database Guide](./DATABASE_GUIDE.md)
- [API Reference](./API_REFERENCE.md)
